#################

#' Title
#'
#' @param user_defined
#'
#' @return
#' @export
#'
#' @examples
getControlList <- function(type = "ui") {

  type <- match.arg(type, c("ui", "handler"))

  uiControlList <- list(
    x = "mappingXUI",
    y = "mappingYUI",
    color = "mappingColorUI",
    shape = "mappingShapeUI",
    size = "mappingSizeUI",
    fill = "mappingFillUI",
    group = "mappingGroupUI",
    stat = "argsStatUI",
    position = "argsPositionUI",
    alpha = "argsAlphaUI",
    size_geom = "argsSizeUI",
    theme = "themeUI",
    theme_choose = "themeChooseUI",
    coord_flip = "settingFlipUI",
    facet_grid = "settingFacetUI",
    # misc = "miscUI",
    labs = "labsUI",
    scaleColor = "scaleColorUI"
  )

  handlerControlList <- list(
    labs = "labsHandler",
    theme = "themeHandler",
    theme_choose = "themeChooseHandler",
    facet_grid = "facetHandler",
    coord_flip = "flipHandler"
  )

  if (type == "ui") {
    return(uiControlList)
  }

  if (type == "handler") {
    return(handlerControlList)
  }

}

#' Title
#'
#' @param ui_part
#'
#' @return
#' @export
#'
#' @examples
matchControls <- function(selected, type = "ui") {

  controlList <- getControlList(type)

  if ( is.null(controlList[[selected]]) ) {
    warning( paste("The", type, "part for", selected, "has not been implemented yet.")  )
    return(NULL)
  } else {
    # return( getFromNamespace(controlList[[selected]], asNamespace("ggpaintr")) )
    return( match.fun(controlList[[selected]]) )
  }

}

#' Title
#'
#' @param name
#' @param mp
#' @param defaultArgs
#' @param extraFunc optional. A named list of extra functions provided by the user.
#' For example `list(param1 = my_func1, param2 = my_func2)`
#' @param extraFuncArgs optional. A list of function arguments provided by the user.
#' Function arguments of one function should be formed in a list as one element of `extraFuncArgs`
#' For example `list(param1 = list(my_func1_arg1, my_func1_arg2), param2 = list(my_func2_arg1, my_func2_arg2))`
#'
#'
#' @note `extraFunc` and `extraFuncArgs` allow users to override
#'
#'
#' @return
#' @export
#'
#' @examples
callFuncUI <- function(name, defaultArgs, extraFunc = NULL, extraFuncArgs = NULL) {

  if ( is.null(name) ) {
    return(NULL)
  }

  UI_FUN <- if (!is.null(extraFunc[[name]])) {
    extraFunc[[name]]
  } else {
    matchControls(name)
  }

  if( !is.null(UI_FUN) ) {

    # UI_FUN_args_names <- names(formals(UI_FUN))[sapply(formals(UI_FUN), is.symbol)]
    UI_FUN_args_names <- names(formals(UI_FUN))

    UI_FUN_args <- if( !is.null(extraFuncArgs[[name]]) ) {
      extraFuncArgs[[name]]
    } else {
      defaultArgs[UI_FUN_args_names]
    }

    return( do.call(UI_FUN, check_remove_null(UI_FUN_args)) )
  } else {
    return(NULL)
  }

}

#' Title
#'
#' @param id
#' @param data
#' @param mapping
#' @param geom_args
#' @param extra_uiFunc
#' @param extra_uiFuncArgs
#'
#' @return
#' @export
#'
#' @examples
controlUI <- function(id, data_vars, mapping, defaultArgs, geom_args = NULL, plot_settings = NULL,
                      extra_uiFunc = NULL, extra_uiFuncArgs = NULL) {
  ns <- NS(id)

  mapping <- check_char_set_names(mapping)
  geom_args <- check_char_set_names(geom_args)
  plot_settings <- check_char_set_names(plot_settings)

  mapping_ui <- mapply(callFuncUI, names(mapping),
                       MoreArgs = list(
                         defaultArgs = defaultArgs, # list(ns = ns, data_vars = data_vars),
                         extraFunc = extra_uiFunc,
                         extraFuncArgs = extra_uiFuncArgs
                       ),
                       SIMPLIFY = FALSE)

  geom_args_ui <- mapply(callFuncUI, names(geom_args),
                         MoreArgs = list(
                           defaultArgs = defaultArgs,
                           extraFunc = extra_uiFunc,
                           extraFuncArgs = extra_uiFuncArgs
                         ),
                         SIMPLIFY = FALSE)

  plot_settings_ui <- mapply(callFuncUI, names(plot_settings),
                             MoreArgs = list(
                               defaultArgs = defaultArgs,
                               extraFunc = extra_uiFunc,
                               extraFuncArgs = extra_uiFuncArgs
                             ),
                             SIMPLIFY = FALSE)


  mapping_ui <- check_remove_null(mapping_ui)
  geom_args_ui <- check_remove_null(geom_args_ui)
  plot_settings_ui <- check_remove_null(plot_settings_ui)

  result <- list(
    ui = list(mapping = empty_list_null(purrr::map(mapping_ui, 1)),
              geom_args = empty_list_null(purrr::map(geom_args_ui, 1)),
              plot_settings = empty_list_null(purrr::map(plot_settings_ui, 1))),
    id = list(mapping = empty_list_null(purrr::map(mapping_ui, 2)),
               geom_args = empty_list_null(purrr::map(geom_args_ui, 2)),
               plot_settings = empty_list_null(purrr::map(plot_settings_ui, 2)))
  )

  return(result)

}
